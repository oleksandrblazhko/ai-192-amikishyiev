# Тестування ін’єкції для IMAP SMTP

## Підсумок

Ця загроза впливає на всі програми, які взаємодіють із поштовими серверами (IMAP/SMTP), як правило, з програмами електронних скриньок. Метою цього тесту є перевірка здатності вводити довільні команди IMAP/SMTP у поштові сервери через те, що вхідні дані не очищаються належним чином.

Техніка ін’єкції IMAP/SMTP є більш ефективною, якщо поштовий сервер недоступний безпосередньо з Інтернету. Там, де можливий повний зв’язок із внутрішнім поштовим сервером, рекомендується проводити пряме тестування.

Ін’єкція IMAP/SMTP дає змогу отримати доступ до поштового сервера, до якого інакше було б неможливо отримати прямий доступ через Інтернет. У деяких випадках ці внутрішні системи не мають того самого рівня безпеки інфраструктури та захисту, який застосовується до зовнішніх веб-серверів. Таким чином, результати поштового сервера можуть бути більш вразливими до атак кінцевих користувачів (див. схему, представлену на малюнку 1).
![image](https://github.com/oleksandrblazhko/ai-192-amikishyiev/assets/123385187/1e7b32a4-1f67-45e7-8669-645e70fd0d71)
*Малюнок 4.7.10-1: Зв’язок із поштовими серверами за допомогою техніки ін’єкції IMAP/SMTP*

На малюнку 1 зображено потік трафіку, який зазвичай спостерігається при використанні технологій веб-пошти. На етапах 1 і 2 користувач взаємодіє з клієнтом веб-пошти, тоді як на етапі 2 тестувальник обходить клієнт веб-пошти та безпосередньо взаємодіє з внутрішніми поштовими серверами.

Ця техніка дозволяє здійснювати різноманітні дії та атаки. Можливості залежать від типу та обсягу ін’єкції та технології поштового сервера, що перевіряється.
Нижче наведено кілька прикладів атак із застосуванням технології ін’єкції IMAP/SMTP:
- Експлуатація вразливостей у протоколі IMAP/SMTP
- Ухилення від обмежень програми
- Ухилення від процесу автоматизації
- Витік інформації
- Реле/СПАМ

## Мета тестуваннь
- Визначте точки ін’єкції IMAP/SMTP.
- Розуміти потік даних і структуру розгортання системи.
- Оцініти вплив ін’єкції.

## Як тестувати
### Виявлення вразливих параметрів
Щоб виявити вразливі параметри, тестувальник повинен проаналізувати здатність програми обробляти вхідні дані. Тестування перевірки вхідних даних вимагає, щоб тестувальник надсилав фальшиві або шкідливі запити на сервер і аналізував відповідь. У захищеній програмі відповіддю має бути повідомлення про помилку з певною відповідною дією, яка сповіщає клієнта про те, що щось пішло не так. У вразливій програмі зловмисний запит може бути оброблено серверною програмою, яка відповість **HTTP 200 OK**.

Важливо відзначити, що запити, які надсилаються, повинні відповідати технології, яка тестується. Надсилання рядків SQL-ін’єкції для сервера Microsoft SQL, коли використовується сервер MySQL, призведе до хибно позитивних відповідей. У цьому випадку надсилання зловмисних команд IMAP є modus operandi (методом дій), оскільки IMAP є основним протоколом, який тестується.
Спеціальні параметри IMAP, які слід використовувати саме:
| **On the IMAP server** | **On the SMTP server** |
|:-------------------:|:-------------------:|
|Автентифікація | Відправник електронної скриньки | 
|операції з поштовими скриньками (перерахувати, читати, створювати, видаляти, перейменовувати) | Цільова адреса електронної пошти |
|операції з повідомленнями (читання, копіювання, переміщення, видалення) | Тема |
|Відключення | Вміст повідомлення |
| | Прикріплені файли |

У цьому прикладі параметр «mailbox» перевіряється шляхом маніпулювання всіма запитами з параметром у:
```
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46106&startMessage=1
```
Можна використати наступні приклади.
- Присвоїти параметру нульове значення:
  ```
  http://<webmail>/src/read_body.php?mailbox=&passed_id=46106&startMessage=1
  ```
- Замініти значення випадковим значенням:
  ```
  http://<webmail>/src/read_body.php?mailbox=NOTEXIST&passed_id=46106&startMessage=1
  ```
- Додати до параметра інші значення:
  ```
  http://<webmail>/src/read_body.php?mailbox=INBOX PARAMETER2&passed_id=46106&startMessage=1
  ```
- Додати нестандартні спеціальні символи (наприклад: **\**, **'**, **"**, **@**, **#**, **!**, **|**):
  ```
  http://<webmail>/src/read_body.php?mailbox=INBOX"&passed_id=46106&startMessage=1
  ```
- Видалити параметр:
  ```
  http://<webmail>/src/read_body.php?passed_id=46106&startMessage=1
  ``` 
Кінцевий результат вищевказаного тестування дає тестувальнику три можливі ситуації: S1 – Програма повертає код помилки/повідомлення S2 – Програма не повертає код помилки/повідомлення, але не виконує запитану операцію S3 – програма не повертає код/повідомлення про помилку та нормально виконує запитану операцію</br>

Ситуації S1 і S2 вказують на успішне впровадження IMAP/SMTP.</br>

Метою зловмисника є отримання відповіді S1, оскільки це вказує на те, що програма є вразливою до ін’єкцій та подальших маніпуляцій.</br>
Припустимо, що користувач отримує заголовки електронних листів за допомогою наступного запиту HTTP:
```
http://<webmail>/src/view_header.php?mailbox=INBOX&passed_id=46105&passed_ent_id=0
```
Зловмисник може змінити значення параметра INBOX, вставивши символ **"** (%22 з використанням кодування URL):
```
http://<webmail>/src/view_header.php?mailbox=INBOX%22&passed_id=46105&passed_ent_id=0
```
У цьому випадку відповіддю заявки може бути:
```
ERROR: Bad or malformed request.
Query: SELECT "INBOX""
Server responded: Unexpected extra arguments to Select
```
Ситуацію S2 важче перевірити успішно. Тестувальник повинен використати сліпу ін’єкцію команди, щоб визначити, чи є сервер уразливим.</br>

З іншого боку, остання ситуація (S3) не є релевантною для цього параграфа.</br>
*Перелік вразливих параметрів*</br>
- *Пошкоджена функціональність*</br>
- *Тип можливої ін'єкції (IMAP/SMTP)*</br>
## Розуміння потоку даних та структури розгортання клієнта

Після визначення всіх уразливих параметрів (наприклад, **passed_id**) тестувальник повинен визначити, який рівень ін’єкції можливий, а потім розробити план тестування для подальшої експлуатації програми.

У цьому тестовому випадку ми виявили, що параметр **pass_id** програми вразливий і використовується в такому запиті:
```
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46225&startMessage=1
```
Використовуючи наступний тестовий приклад (надання алфавітного значення, коли потрібне числове значення):
```
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=test&startMessage=1
```
створить наступне повідомлення про помилку:
```
ERROR : Bad or malformed request.
Query: FETCH test:test BODY[HEADER]
Server responded: Error in IMAP command received by server.
```
У цьому прикладі повідомлення про помилку повернуло назву виконаної команди та відповідні параметри.

В інших ситуаціях повідомлення про помилку (**not controlled (не контролюється)** програмою) містить назву виконаної команди, але читання відповідного [RFC](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/10-Testing_for_IMAP_SMTP_Injection#references) дозволяє тестувальнику зрозуміти, які інші можливі команди можна виконати.

Якщо програма не повертає описових повідомлень про помилку, тестувальник повинен проаналізувати уражену функцію, щоб вивести всі можливі команди (і параметри), пов’язані з вищезгаданою функціональністю. Наприклад, якщо у функції створення поштової скриньки було виявлено вразливий параметр, логічно припустити, що зачеплена команда IMAP — це **CREATE**. Згідно з RFC, команда **CREATE** приймає один параметр, який визначає ім’я поштової скриньки для створення.</br>

*Список команд IMAP/SMTP, що підлягають впливу*</br>
- *Тип, значення та кількість параметрів, які очікуються відповідними командами IMAP/SMTP*</br>
      
## Ін'єкція команд IMAP/SMTP
Коли тестувальник виявив вразливі параметри та проаналізував контекст їх виконання, наступним етапом є експлуатація функціоналу.</br>
Цей етап має два можливі наслідки:
 1. Ін’єкція можлива в неавтентифікованому стані: уражена функціональність не вимагає автентифікації користувача. Доступні ін’єкційні (IMAP) команди обмежені: **CAPABILITY**, **NOOP**, **AUTHENTICATE**, **LOGIN** і **LOGOUT**.</br>
 2. Ін’єкція можлива лише в автентифікованому стані: для успішного використання потрібно, щоб користувач пройшов повну автентифікацію, перш ніж тестування буде продовженим.

У будь-якому випадку, типова структура ін’єкції IMAP/SMTP виглядає наступним чином:
 - Header (Заголовок): закінчення очікуваної команди;
 - Body (Тіло): ін'єкція нової команди;
 - Footer (Нижній колонтитул): початок очікуваної команди.

Важливо пам’ятати, що для того, щоб виконати команду IMAP/SMTP, попередню команду необхідно завершити послідовністю CRLF (%0d%0a*).

Припустимо, що на етапі [визначення вразливих параметрів](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/10-Testing_for_IMAP_SMTP_Injection#identifying-vulnerable-parameters) зловмисник виявляє, що параметр **message_id** у наступному запиті є вразливим:
```
http://<webmail>/read_email.php?message_id=4791
```
Припустимо також, що результат аналізу, виконаного на етапі 2 («Розуміння потоку даних і структури розгортання клієнта»), визначив команду та аргументи, пов’язані з цим параметром, як:
```
FETCH 4791 BODY[HEADER]
```
У цьому сценарії, структура ін’єкції IMAP буде такою:
```
http://<webmail>/read_email.php?message_id=4791 BODY[HEADER]%0d%0aV100 CAPABILITY%0d%0aV101 FETCH 4791
```
Який створював би наступні команди:
```
???? FETCH 4791 BODY[HEADER]
V100 CAPABILITY
V101 FETCH 4791 BODY[HEADER]
```
де:
```
Header = 4791 BODY[HEADER]
Body   = %0d%0aV100 CAPABILITY%0d%0a
Footer = V101 FETCH 4791
```
*Список команд IMAP/SMTP, що підлягають впливу*</br>
- *Довільна ін’єкція команди IMAP/SMTP*</br>


